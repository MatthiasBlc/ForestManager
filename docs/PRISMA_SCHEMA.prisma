// =============================================================================
// Forest Manager - Prisma Schema
// =============================================================================
// Ce fichier est une RÉFÉRENCE pour le schéma à implémenter.
// Copier dans backend/prisma/schema.prisma après validation.
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// SESSION (pour express-session)
// =============================================================================

model Session {
  id        String   @id
  sid       String   @unique
  data      String
  expiresAt DateTime
}

// =============================================================================
// USER
// =============================================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // Relations
  communities       UserCommunity[]
  recipes           Recipe[]           @relation("RecipeCreator")
  proposals         RecipeUpdateProposal[] @relation("ProposalProposer")
  activities        ActivityLog[]
  recipeViews       RecipeView[]

  @@index([email])
  @@index([username])
  @@index([deletedAt])
}

// =============================================================================
// COMMUNITY
// =============================================================================

model Community {
  id          String     @id @default(uuid())
  name        String
  description String?
  visibility  Visibility @default(INVITE_ONLY)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?

  // Relations
  members         UserCommunity[]
  recipes         Recipe[]        @relation("CommunityRecipes")
  sharedRecipes   Recipe[]        @relation("SharedFromCommunity")
  activities      ActivityLog[]

  @@index([deletedAt])
}

enum Visibility {
  INVITE_ONLY
}

// =============================================================================
// USER-COMMUNITY (Pivot table avec rôle)
// =============================================================================

model UserCommunity {
  id          String   @id @default(uuid())
  userId      String
  communityId String
  role        Role     @default(MEMBER)
  joinedAt    DateTime @default(now())
  deletedAt   DateTime?

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([userId])
  @@index([communityId])
  @@index([deletedAt])
}

enum Role {
  MEMBER
  ADMIN
}

// =============================================================================
// RECIPE
// =============================================================================

model Recipe {
  id                    String    @id @default(uuid())
  title                 String
  content               String    // Markdown ou rich text
  imageUrl              String?
  isVariant             Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  deletedAt             DateTime?

  // Relations - Ownership
  creatorId             String
  creator               User      @relation("RecipeCreator", fields: [creatorId], references: [id])

  // Relations - Community (null = catalogue personnel)
  communityId           String?
  community             Community? @relation("CommunityRecipes", fields: [communityId], references: [id], onDelete: SetNull)

  // Relations - Origin (pour forks et variantes)
  originRecipeId        String?
  originRecipe          Recipe?   @relation("RecipeVariants", fields: [originRecipeId], references: [id], onDelete: SetNull)
  variants              Recipe[]  @relation("RecipeVariants")

  // Relations - Shared from (pour traçabilité des forks)
  sharedFromCommunityId String?
  sharedFromCommunity   Community? @relation("SharedFromCommunity", fields: [sharedFromCommunityId], references: [id], onDelete: SetNull)

  // Relations - Other
  tags                  RecipeTag[]
  ingredients           RecipeIngredient[]
  proposals             RecipeUpdateProposal[]
  analytics             RecipeAnalytics?
  views                 RecipeView[]
  activities            ActivityLog[]

  @@index([creatorId])
  @@index([communityId])
  @@index([originRecipeId])
  @@index([deletedAt])
}

// =============================================================================
// RECIPE UPDATE PROPOSAL
// =============================================================================

model RecipeUpdateProposal {
  id              String         @id @default(uuid())
  proposedTitle   String
  proposedContent String
  status          ProposalStatus @default(PENDING)
  createdAt       DateTime       @default(now())
  decidedAt       DateTime?
  deletedAt       DateTime?

  // Relations
  recipeId        String
  recipe          Recipe         @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  proposerId      String
  proposer        User           @relation("ProposalProposer", fields: [proposerId], references: [id])

  @@index([recipeId])
  @@index([proposerId])
  @@index([status])
  @@index([deletedAt])
}

enum ProposalStatus {
  PENDING
  ACCEPTED
  REJECTED
}

// =============================================================================
// TAG & RECIPE-TAG
// =============================================================================

model Tag {
  id      String      @id @default(uuid())
  name    String      @unique

  // Relations
  recipes RecipeTag[]

  @@index([name])
}

model RecipeTag {
  recipeId String
  tagId    String

  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([recipeId, tagId])
  @@index([tagId])
}

// =============================================================================
// INGREDIENT & RECIPE-INGREDIENT
// =============================================================================

model Ingredient {
  id   String @id @default(uuid())
  name String @unique

  // Relations
  recipes RecipeIngredient[]

  @@index([name])
}

model RecipeIngredient {
  id           String  @id @default(uuid())
  recipeId     String
  ingredientId String
  quantity     String?
  order        Int     @default(0)

  recipe     Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredient Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@unique([recipeId, ingredientId])
  @@index([recipeId])
}

// =============================================================================
// ACTIVITY LOG
// =============================================================================

model ActivityLog {
  id          String       @id @default(uuid())
  type        ActivityType
  metadata    Json?        // Données additionnelles
  createdAt   DateTime     @default(now())

  // Relations
  userId      String
  user        User         @relation(fields: [userId], references: [id])

  communityId String?
  community   Community?   @relation(fields: [communityId], references: [id], onDelete: SetNull)

  recipeId    String?
  recipe      Recipe?      @relation(fields: [recipeId], references: [id], onDelete: SetNull)

  @@index([communityId])
  @@index([userId])
  @@index([createdAt])
  @@index([type])
}

enum ActivityType {
  RECIPE_CREATED
  RECIPE_SHARED
  VARIANT_PROPOSED
  VARIANT_CREATED
  PROPOSAL_ACCEPTED
  PROPOSAL_REJECTED
  USER_JOINED
  USER_LEFT
  USER_PROMOTED
}

// =============================================================================
// ANALYTICS (Optionnel - préparé pour le futur)
// =============================================================================

model RecipeAnalytics {
  id            String   @id @default(uuid())
  recipeId      String   @unique
  views         Int      @default(0)
  shares        Int      @default(0)
  forks         Int      @default(0)
  lastUpdatedAt DateTime @updatedAt

  // Relations
  recipe        Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
}

model RecipeView {
  id        String   @id @default(uuid())
  viewedAt  DateTime @default(now())

  // Relations
  recipeId  String
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([recipeId])
  @@index([viewedAt])
}
