// =============================================================================
// Forest Manager - Prisma Schema
// =============================================================================
// Ce fichier est une REFERENCE pour le schema a implementer.
// Copier dans backend/prisma/schema.prisma apres validation.
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// SESSION (pour express-session avec @quixo3/prisma-session-store)
// =============================================================================

model Session {
  id        String   @id
  sid       String   @unique
  data      String
  expiresAt DateTime
}

// =============================================================================
// ADMIN SESSION (isolee pour SuperAdmin - securite renforcee)
// =============================================================================

model AdminSession {
  id        String   @id
  sid       String   @unique
  data      String
  expiresAt DateTime
}

// =============================================================================
// ADMIN USER (SuperAdmin - completement isole de User)
// Authentification 2FA TOTP obligatoire
// =============================================================================

model AdminUser {
  id          String    @id @default(uuid())
  email       String    @unique
  username    String    @unique
  password    String    // bcrypt hash
  totpSecret  String    // Secret TOTP pour 2FA (Google Authenticator)
  totpEnabled Boolean   @default(false) // Active apres premiere config
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  featuresGranted CommunityFeature[] @relation("FeatureGrantedBy")
  activities      AdminActivityLog[]

  @@index([email])
  @@index([username])
}

// =============================================================================
// FEATURE (Briques/Modules attribuables aux communautes)
// =============================================================================

model Feature {
  id          String   @id @default(uuid())
  code        String   @unique  // "MVP", "MEAL_PLANNER", etc.
  name        String            // "Fonctionnalites de base"
  description String?
  isDefault   Boolean  @default(false) // Attribue auto a la creation communaute
  createdAt   DateTime @default(now())

  // Relations
  communities CommunityFeature[]

  @@index([code])
}

// =============================================================================
// COMMUNITY-FEATURE (Pivot - attribution des briques aux communautes)
// =============================================================================

model CommunityFeature {
  id          String    @id @default(uuid())
  communityId String
  featureId   String
  grantedAt   DateTime  @default(now())
  grantedById String?   // AdminUser qui a attribue (null si auto/default)
  revokedAt   DateTime? // Soft revoke (garder historique)

  // Relations
  community Community  @relation(fields: [communityId], references: [id])
  feature   Feature    @relation(fields: [featureId], references: [id])
  grantedBy AdminUser? @relation("FeatureGrantedBy", fields: [grantedById], references: [id])

  @@unique([communityId, featureId])
  @@index([communityId])
  @@index([featureId])
}

// =============================================================================
// ADMIN ACTIVITY LOG (Audit des actions SuperAdmin)
// =============================================================================

model AdminActivityLog {
  id         String          @id @default(uuid())
  type       AdminActionType
  targetType String?         // "Community", "Tag", "Ingredient", "Feature"
  targetId   String?
  metadata   Json?           // Donnees additionnelles (ancien nom, nouveau nom, etc.)
  createdAt  DateTime        @default(now())

  // Relations
  adminId String
  admin   AdminUser @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([type])
  @@index([createdAt])
}

enum AdminActionType {
  // Tags
  TAG_CREATED
  TAG_UPDATED
  TAG_DELETED
  TAG_MERGED

  // Ingredients
  INGREDIENT_CREATED
  INGREDIENT_UPDATED
  INGREDIENT_DELETED
  INGREDIENT_MERGED

  // Communities
  COMMUNITY_RENAMED
  COMMUNITY_DELETED

  // Features
  FEATURE_CREATED
  FEATURE_UPDATED
  FEATURE_GRANTED
  FEATURE_REVOKED

  // Admin auth
  ADMIN_LOGIN
  ADMIN_LOGOUT
  ADMIN_TOTP_SETUP
}

// =============================================================================
// USER
// =============================================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // Relations
  communities       UserCommunity[]
  recipes           Recipe[]               @relation("RecipeCreator")
  proposals         RecipeUpdateProposal[] @relation("ProposalProposer")
  activities        ActivityLog[]
  recipeViews       RecipeView[]
  invitesSent       CommunityInvite[]      @relation("InviteSender")
  invitesReceived   CommunityInvite[]      @relation("InviteReceiver")

  @@index([email])
  @@index([username])
  @@index([deletedAt])
}

// =============================================================================
// COMMUNITY
// =============================================================================

model Community {
  id          String     @id @default(uuid())
  name        String
  description String?
  visibility  Visibility @default(INVITE_ONLY)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?

  // Relations
  members         UserCommunity[]
  recipes         Recipe[]          @relation("CommunityRecipes")
  sharedRecipes   Recipe[]          @relation("SharedFromCommunity")
  activities      ActivityLog[]
  invites         CommunityInvite[]
  features        CommunityFeature[] // Briques attribuees a cette communaute

  @@index([deletedAt])
}

enum Visibility {
  INVITE_ONLY
}

// =============================================================================
// USER-COMMUNITY (Pivot table avec role)
// Note: Soft delete gere cote applicatif - pas de onDelete Cascade
// =============================================================================

model UserCommunity {
  id          String   @id @default(uuid())
  userId      String
  communityId String
  role        Role     @default(MEMBER)
  joinedAt    DateTime @default(now())
  deletedAt   DateTime?

  // Relations (pas de Cascade - soft delete applicatif)
  user      User      @relation(fields: [userId], references: [id])
  community Community @relation(fields: [communityId], references: [id])

  @@unique([userId, communityId])
  @@index([userId])
  @@index([communityId])
  @@index([deletedAt])
}

// Roles pour les membres d'une communaute (distinct de AdminUser/SuperAdmin)
enum Role {
  MEMBER
  MODERATOR
}

// =============================================================================
// COMMUNITY INVITE (Systeme d'invitation avec acceptation explicite)
// =============================================================================

model CommunityInvite {
  id          String       @id @default(uuid())
  communityId String
  inviterId   String       // Admin qui envoie l'invitation
  inviteeId   String       // Utilisateur invite
  status      InviteStatus @default(PENDING)
  createdAt   DateTime     @default(now())
  respondedAt DateTime?    // Date de reponse (accept/reject)
  deletedAt   DateTime?

  // Relations
  community Community @relation(fields: [communityId], references: [id])
  inviter   User      @relation("InviteSender", fields: [inviterId], references: [id])
  invitee   User      @relation("InviteReceiver", fields: [inviteeId], references: [id])

  // Note: Pas de @@unique car on garde l'historique des invitations
  // La contrainte "une seule PENDING par user/community" est geree cote applicatif
  // Avant de creer une invitation: verifier qu'il n'existe pas de PENDING pour ce couple
  @@index([communityId])
  @@index([inviteeId])
  @@index([status])
  @@index([deletedAt])
  @@index([communityId, inviteeId, status]) // Index composite pour la verification
}

enum InviteStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED // Si l'admin annule l'invitation
}

// =============================================================================
// RECIPE
// Note: Soft delete gere cote applicatif
// =============================================================================

model Recipe {
  id                    String    @id @default(uuid())
  title                 String
  content               String    // Markdown ou rich text
  imageUrl              String?   // Optionnel - stockage differe a V1
  isVariant             Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  deletedAt             DateTime?

  // Relations - Ownership
  creatorId             String
  creator               User      @relation("RecipeCreator", fields: [creatorId], references: [id])

  // Relations - Community (null = catalogue personnel)
  communityId           String?
  community             Community? @relation("CommunityRecipes", fields: [communityId], references: [id])

  // Relations - Origin (pour forks, variantes, et lien perso/communautaire)
  // Si originRecipe.communityId == null -> c'est la recette personnelle liee
  // Si isVariant == true -> c'est une variante
  // Si sharedFromCommunityId != null -> c'est un fork inter-communautes
  originRecipeId        String?
  originRecipe          Recipe?   @relation("RecipeVariants", fields: [originRecipeId], references: [id])
  variants              Recipe[]  @relation("RecipeVariants")

  // Relations - Shared from (pour tracabilite des forks)
  sharedFromCommunityId String?
  sharedFromCommunity   Community? @relation("SharedFromCommunity", fields: [sharedFromCommunityId], references: [id])

  // Relations - Other
  tags                  RecipeTag[]
  ingredients           RecipeIngredient[]
  proposals             RecipeUpdateProposal[]
  analytics             RecipeAnalytics?
  views                 RecipeView[]
  activities            ActivityLog[]

  @@index([creatorId])
  @@index([communityId])
  @@index([originRecipeId])
  @@index([deletedAt])
}

// =============================================================================
// RECIPE UPDATE PROPOSAL
// Note: Soft delete gere cote applicatif
// =============================================================================

model RecipeUpdateProposal {
  id              String         @id @default(uuid())
  proposedTitle   String
  proposedContent String
  status          ProposalStatus @default(PENDING)
  createdAt       DateTime       @default(now())
  decidedAt       DateTime?
  deletedAt       DateTime?

  // Relations (pas de Cascade - soft delete applicatif)
  recipeId        String
  recipe          Recipe         @relation(fields: [recipeId], references: [id])

  proposerId      String
  proposer        User           @relation("ProposalProposer", fields: [proposerId], references: [id])

  @@index([recipeId])
  @@index([proposerId])
  @@index([status])
  @@index([deletedAt])
}

enum ProposalStatus {
  PENDING
  ACCEPTED
  REJECTED
}

// =============================================================================
// TAG & RECIPE-TAG
// Note: Tables pivot - Cascade OK (hard delete quand recette supprimee)
// =============================================================================

model Tag {
  id      String      @id @default(uuid())
  name    String      @unique

  // Relations
  recipes RecipeTag[]

  @@index([name])
}

model RecipeTag {
  recipeId String
  tagId    String

  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([recipeId, tagId])
  @@index([tagId])
}

// =============================================================================
// INGREDIENT & RECIPE-INGREDIENT
// Note: Ingredients crees a la volee (comme les tags)
// Tables pivot - Cascade OK
// =============================================================================

model Ingredient {
  id   String @id @default(uuid())
  name String @unique

  // Relations
  recipes RecipeIngredient[]

  @@index([name])
}

model RecipeIngredient {
  id           String  @id @default(uuid())
  recipeId     String
  ingredientId String
  quantity     String?
  order        Int     @default(0)

  recipe     Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredient Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@unique([recipeId, ingredientId])
  @@index([recipeId])
}

// =============================================================================
// ACTIVITY LOG
// =============================================================================

model ActivityLog {
  id          String       @id @default(uuid())
  type        ActivityType
  metadata    Json?        // Donnees additionnelles
  createdAt   DateTime     @default(now())

  // Relations
  userId      String
  user        User         @relation(fields: [userId], references: [id])

  communityId String?
  community   Community?   @relation(fields: [communityId], references: [id])

  recipeId    String?
  recipe      Recipe?      @relation(fields: [recipeId], references: [id])

  @@index([communityId])
  @@index([userId])
  @@index([createdAt])
  @@index([type])
}

enum ActivityType {
  // Recettes
  RECIPE_CREATED
  RECIPE_UPDATED
  RECIPE_DELETED
  RECIPE_SHARED

  // Variantes et propositions
  VARIANT_PROPOSED
  VARIANT_CREATED
  PROPOSAL_ACCEPTED
  PROPOSAL_REJECTED

  // Membres
  USER_JOINED
  USER_LEFT
  USER_KICKED
  USER_PROMOTED

  // Invitations
  INVITE_SENT        // Invitation envoyee
  INVITE_ACCEPTED    // Invitation acceptee
  INVITE_REJECTED    // Invitation refusee
  INVITE_CANCELLED   // Invitation annulee par admin
}

// =============================================================================
// ANALYTICS (Optionnel - prepare pour le futur)
// Tables techniques - Cascade OK
// =============================================================================

model RecipeAnalytics {
  id            String   @id @default(uuid())
  recipeId      String   @unique
  views         Int      @default(0)
  shares        Int      @default(0)
  forks         Int      @default(0)
  lastUpdatedAt DateTime @updatedAt

  // Relations
  recipe        Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
}

model RecipeView {
  id        String   @id @default(uuid())
  viewedAt  DateTime @default(now())

  // Relations
  recipeId  String
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  @@index([recipeId])
  @@index([viewedAt])
}
